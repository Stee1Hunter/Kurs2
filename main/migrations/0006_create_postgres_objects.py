# Generated by Django 5.2.3 on 2026-02-11 14:25

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('main', '0007_product_average_rating'),
    ]

    operations = [
        # üîπ –§–£–ù–ö–¶–ò–ò
        migrations.RunSQL(
            sql="""
            CREATE OR REPLACE FUNCTION get_basket_count(p_user_id INT)
            RETURNS INT AS $$
            BEGIN
                RETURN COALESCE((SELECT SUM(quantity) FROM main_basket WHERE user_id = p_user_id), 0);
            END;
            $$ LANGUAGE plpgsql;
            
            -- 2. –§—É–Ω–∫—Ü–∏—è: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∂–µ–ª–∞–µ–º–æ–º —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            CREATE OR REPLACE FUNCTION get_wishlist_count(p_user_id INT)
            RETURNS INT AS $$
            BEGIN
                RETURN COALESCE((SELECT COUNT(*) FROM main_wishlist WHERE user_id = p_user_id), 0);
            END;
            $$ LANGUAGE plpgsql;
            
            -- 3. –§—É–Ω–∫—Ü–∏—è: —Å—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            CREATE OR REPLACE FUNCTION get_basket_total(p_user_id INT)
            RETURNS NUMERIC(10,2) AS $$
            BEGIN
                RETURN COALESCE((
                    SELECT SUM(b.quantity * p.price)
                    FROM main_basket b
                    JOIN main_product p ON b.product_id = p.id
                    WHERE b.user_id = p_user_id
                ), 0.00);
            END;
            $$ LANGUAGE plpgsql;
            """,
            reverse_sql="""
            DROP FUNCTION IF EXISTS get_basket_count(INT);
            DROP FUNCTION IF EXISTS get_wishlist_count(INT);
            DROP FUNCTION IF EXISTS get_basket_total(INT);
            """
        ),

        # üîπ –¢–†–ò–ì–ì–ï–†–´
        migrations.RunSQL(
            sql="""
            -- 1. –¢—Ä–∏–≥–≥–µ—Ä: –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ discount ‚Üí old_price = price, price = price * (1 - discount/100)
            CREATE OR REPLACE FUNCTION update_price_on_discount()
            RETURNS TRIGGER AS $$
            BEGIN
                IF NEW.discount IS NOT NULL AND NEW.discount > 0 THEN
                    NEW.old_price := NEW.price;
                    NEW.price := ROUND(NEW.price * (100 - NEW.discount) / 100, 2);
                END IF;
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;

            CREATE TRIGGER trg_update_price_on_discount
            BEFORE INSERT OR UPDATE OF discount ON main_product
            FOR EACH ROW
            EXECUTE FUNCTION update_price_on_discount();

            -- 2. –¢—Ä–∏–≥–≥–µ—Ä: –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ –±–µ–∑ –ø–æ–∫—É–ø–∫–∏
            CREATE OR REPLACE FUNCTION prevent_review_without_purchase()
            RETURNS TRIGGER AS $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1
                    FROM main_orderitem oi
                    JOIN main_order o ON oi.order_id = o.id
                    WHERE oi.product_id = NEW.product_id
                      AND o.user_id = NEW.user_id
                ) THEN
                    RAISE EXCEPTION '–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞';
                END IF;
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;

            CREATE TRIGGER trg_prevent_fake_review
            BEFORE INSERT ON main_review
            FOR EACH ROW
            EXECUTE FUNCTION prevent_review_without_purchase();

            -- 3. –¢—Ä–∏–≥–≥–µ—Ä: –æ–±–Ω–æ–≤–ª—è—Ç—å created_at –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É
            CREATE OR REPLACE FUNCTION set_basket_created_at_now()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.created_at := NOW();
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;

            CREATE TRIGGER trg_set_basket_timestamp
            BEFORE INSERT ON main_basket
            FOR EACH ROW
            EXECUTE FUNCTION set_basket_created_at_now();
            """,
            reverse_sql="""
            DROP TRIGGER IF EXISTS trg_update_price_on_discount ON main_product;
            DROP TRIGGER IF EXISTS trg_prevent_fake_review ON main_review;
            DROP TRIGGER IF EXISTS trg_set_basket_timestamp ON main_basket;
            DROP FUNCTION IF EXISTS update_price_on_discount();
            DROP FUNCTION IF EXISTS prevent_review_without_purchase();
            DROP FUNCTION IF EXISTS set_basket_created_at_now();
            """
        ),

        # üîπ –ü–†–û–¶–ï–î–£–†–´
        migrations.RunSQL(
            sql="""
            -- 1. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞: —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
            CREATE OR REPLACE PROCEDURE create_order_from_basket(IN p_user_id INT)
            LANGUAGE plpgsql
            AS $$
            DECLARE
                v_count INT;
                v_total DECIMAL(10,2) := 0;
                v_new_order_id INT;
            BEGIN
                -- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
                SELECT COUNT(*) INTO v_count
                FROM main_basket
                WHERE user_id = p_user_id;
            
                IF v_count = 0 THEN
                    RAISE EXCEPTION '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
                END IF;
            
                -- –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
                SELECT COALESCE(SUM(b.quantity * p.price), 0)
                INTO v_total
                FROM main_basket b
                JOIN main_product p ON b.product_id = p.id
                WHERE b.user_id = p_user_id;
            
                -- –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ —Å NOW() –¥–ª—è created_at
                INSERT INTO main_order (user_id, total_price, status, created_at)
                VALUES (p_user_id, v_total, 'pending', NOW())
                RETURNING id INTO v_new_order_id;
            
                -- –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫–∞–∑–∞
                INSERT INTO main_orderitem (order_id, product_id, quantity, price)
                SELECT v_new_order_id, b.product_id, b.quantity, p.price
                FROM main_basket b
                JOIN main_product p ON b.product_id = p.id
                WHERE b.user_id = p_user_id;
            
                -- –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
                DELETE FROM main_basket WHERE user_id = p_user_id;
            
                RAISE NOTICE '–ó–∞–∫–∞–∑ % —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %', v_new_order_id, p_user_id;
            END;
            $$;

            -- 2. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞: –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É –∫ —Ç–æ–≤–∞—Ä—É
            CREATE OR REPLACE PROCEDURE apply_discount_to_product(IN product_id INT, IN discount_percent INT)
            LANGUAGE plpgsql
            AS $$
            DECLARE
                current_price DECIMAL(10,2);
            BEGIN
                IF discount_percent < 0 OR discount_percent > 100 THEN
                    RAISE EXCEPTION '–°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 100%%';
                END IF;

                SELECT price INTO current_price
                FROM main_product
                WHERE id = product_id;

                IF current_price IS NULL THEN
                    RAISE EXCEPTION '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω';
                END IF;

                UPDATE main_product
                SET
                    old_price = price,
                    price = ROUND(price * (100 - discount_percent) / 100, 2),
                    discount = discount_percent
                WHERE id = product_id;

                RAISE NOTICE '–°–∫–∏–¥–∫–∞ %%% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ —Ç–æ–≤–∞—Ä—É %', discount_percent, product_id;
            END;
            $$;

            -- 3. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞: —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã –∏ –≤–∏—à–ª–∏—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
            CREATE OR REPLACE PROCEDURE cleanup_orphaned_items()
            LANGUAGE plpgsql
            AS $$
            DECLARE
                basket_count INT;
                wishlist_count INT;
            BEGIN
                SELECT COUNT(*) INTO basket_count
                FROM main_basket b
                LEFT JOIN main_product p ON b.product_id = p.id
                WHERE p.id IS NULL;

                SELECT COUNT(*) INTO wishlist_count
                FROM main_wishlist w
                LEFT JOIN main_product p ON w.product_id = p.id
                WHERE p.id IS NULL;

                DELETE FROM main_basket
                WHERE product_id NOT IN (SELECT id FROM main_product);

                DELETE FROM main_wishlist
                WHERE product_id NOT IN (SELECT id FROM main_product);

                RAISE NOTICE '–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: —É–¥–∞–ª–µ–Ω–æ % —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–æ—Ä–∑–∏–Ω –∏ % –∏–∑ —Å–ø–∏—Å–∫–æ–≤ –∂–µ–ª–∞–Ω–∏–π', basket_count, wishlist_count;
            END;
            $$;
             -- 4. –ü–µ—Ä–µ—Å—á—ë—Ç —Å—Ä–µ–¥–Ω–∏—Ö —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
            CREATE OR REPLACE PROCEDURE recalculate_product_ratings()
            LANGUAGE plpgsql
            AS $$
            BEGIN
                UPDATE main_product
                SET average_rating = COALESCE((
                    SELECT ROUND(AVG(rating), 2)
                    FROM main_review
                    WHERE main_review.product_id = main_product.id
                ), 0.00);
                
                RAISE NOTICE '–°—Ä–µ–¥–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã.';
            END;
            $$;
            """,
            reverse_sql="""
            DROP PROCEDURE IF EXISTS create_order_from_basket(INT);
            DROP PROCEDURE IF EXISTS apply_discount_to_product(INT, INT);
            DROP PROCEDURE IF EXISTS cleanup_orphaned_items();
            DROP PROCEDURE IF EXISTS recalculate_product_ratings();
            """
        ),

        # üîπ –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–Ø (–±–µ–∑ is_archived!)
        migrations.RunSQL(
            sql="""
            -- 1. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã —Å –¥–µ—Ç–∞–ª—è–º–∏ (–±–µ–∑ is_archived)
            CREATE OR REPLACE VIEW active_orders_view AS
            SELECT
                o.id AS order_id,
                o.created_at,
                o.status,
                u.username AS user_name,
                u.email AS user_email,
                SUM(oi.quantity * oi.price) AS total,
                COUNT(oi.id) AS items_count
            FROM main_order o
            JOIN auth_user u ON o.user_id = u.id
            JOIN main_orderitem oi ON o.id = oi.order_id
            WHERE o.status != 'cancelled'
            GROUP BY o.id, o.created_at, o.status, u.username, u.email;

            -- 2. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: —Ç–æ–ø-5 —Å–∞–º—ã—Ö –ø—Ä–æ–¥–∞–≤–∞–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
            CREATE OR REPLACE VIEW top_selling_products_view AS
            SELECT
                p.id,
                p.name,
                p.game_id,
                g.name AS game_name,
                SUM(oi.quantity) AS total_sold,
                COUNT(DISTINCT o.id) AS orders_count
            FROM main_product p
            JOIN main_orderitem oi ON p.id = oi.product_id
            JOIN main_order o ON oi.order_id = o.id
            JOIN main_game g ON p.game_id = g.id
            WHERE o.status = 'completed'
            GROUP BY p.id, p.name, p.game_id, g.name
            ORDER BY total_sold DESC
            LIMIT 5;

            -- 3. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∂–µ–ª–∞–Ω–∏–π
            CREATE OR REPLACE VIEW top_wishlists_view AS
            SELECT
                u.id AS user_id,
                u.username,
                u.email,
                COUNT(w.id) AS wishlist_count
            FROM auth_user u
            LEFT JOIN main_wishlist w ON u.id = w.user_id
            GROUP BY u.id, u.username, u.email
            ORDER BY wishlist_count DESC
            LIMIT 10;
            """,
            reverse_sql="""
            DROP VIEW IF EXISTS active_orders_view;
            DROP VIEW IF EXISTS top_selling_products_view;
            DROP VIEW IF EXISTS top_wishlists_view;
            """
        ),
    ]